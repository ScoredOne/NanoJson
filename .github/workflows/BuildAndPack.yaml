name: BuildAndPack
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  build-and-publish:
    permissions:
      contents: read
      id-token: write  # enable GitHub OIDC token issuance for this job

    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Set VERSION variable from tag
        shell: bash
        run: |
          # GITHUB_REF is like: refs/tags/v1.2.3
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "VERSION set to: ${GITHUB_REF#refs/tags/v}"

      - name: dotnet pack
        shell: bash
        run: |
          mkdir -p ./artifacts
          # Use PackageVersion so the produced nupkg has the exact version
          dotnet pack -c Release -p:PackageVersion=${VERSION} -o ./artifacts

      - name: NuGet login (OIDC â†’ temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: ScoredOne

      - name: push to NuGet
        shell: bash
        run: |
          pkg=$(ls ./artifacts/NanoJson.${VERSION}*.nupkg 2>/dev/null | head -n 1 || true)
          if [ -z "$pkg" ]; then
            echo "Package not found: ./artifacts/NanoJson.${VERSION}.nupkg"
            exit 1
          fi
          dotnet nuget push "$pkg" \
            --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" \
            --source https://api.nuget.org/v3/index.json
