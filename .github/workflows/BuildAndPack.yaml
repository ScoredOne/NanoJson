name: BuildAndPack
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  build-and-publish:
    permissions:
      contents: read
      id-token: write  # enable GitHub OIDC token issuance for this job

    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Set VERSION variable from tag
        shell: bash
        run: |
          # GITHUB_REF is like: refs/tags/v1.2.3
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "VERSION set to: ${GITHUB_REF#refs/tags/v}"

      - name: dotnet pack
        shell: bash
        run: |
          mkdir -p ./artifacts
          # Use PackageVersion so the produced nupkg has the exact version
          dotnet pack -c Release -p:PackageVersion=${VERSION} -o ./artifacts

      - name: NuGet login (OIDC → temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: ScoredOne

      - name: Check & delete existing NuGet version
        shell: bash
        run: |
          packageId="NanoJson"
          version="${VERSION}"
          if [ -z "$version" ]; then
            echo "VERSION not set"
            exit 1
          fi

          lower=$(echo "$packageId" | tr '[:upper:]' '[:lower:]')
          checkUrl="https://api.nuget.org/v3-flatcontainer/${lower}/${version}/${lower}.nuspec"
          echo "Checking $checkUrl"

          if curl -sfI "$checkUrl" >/dev/null 2>&1; then
            echo "Version $version of $packageId exists on nuget.org — attempting delete (requires delete permission in API key)."
            apiKey="${{ steps.login.outputs.NUGET_API_KEY }}"
            if [ -z "$apiKey" ]; then
              echo "No NUGET API key available from login step."
              exit 1
            fi

            # Attempt delete. This will fail if the API key doesn't have delete permission or nuget.org disallows deletion.
            dotnet nuget delete "$packageId" "$version" \
              --api-key "$apiKey" \
              --source https://api.nuget.org/v3/index.json \
              --non-interactive

            echo "Delete command finished. Check the previous output for success/failure."
          else
            echo "Version $version of $packageId NOT found on nuget.org — continuing to push."
          fi

      - name: push to NuGet
        shell: bash
        run: |
          pkg=$(ls ./artifacts/NanoJson.${VERSION}*.nupkg 2>/dev/null | head -n 1 || true)
          if [ -z "$pkg" ]; then
            echo "Package not found: ./artifacts/NanoJson.${VERSION}.nupkg"
            exit 1
          fi
          dotnet nuget push "$pkg" \
            --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" \
            --source https://api.nuget.org/v3/index.json
            --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" `
            --source https://api.nuget.org/v3/index.json
