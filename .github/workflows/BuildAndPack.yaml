name: BuildAndPack
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  build-and-publish:
    permissions:
      contents: read
      id-token: write  # enable GitHub OIDC token issuance for this job

    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Set VERSION variable from tag
        shell: bash
        run: |
          # GITHUB_REF is like: refs/tags/v1.2.3
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "VERSION set to: ${GITHUB_REF#refs/tags/v}"

      - name: dotnet pack
        shell: bash
        run: |
          mkdir -p ./artifacts
          # Use PackageVersion so the produced nupkg has the exact version
          dotnet pack -c Release -p:PackageVersion=${VERSION} -o ./artifacts

      - name: NuGet login (OIDC → temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: ScoredOne

      - name: Check & delete existing NuGet version
        shell: pwsh
        run: |
          $packageId = "NanoJson"
          $version = $env:VERSION
          if (-not $version) {
            Write-Error "VERSION not set"
            exit 1
          }

          $lower = $packageId.ToLower()
          # Flat container URL returns 200 if the specific version exists
          $checkUrl = "https://api.nuget.org/v3-flatcontainer/$lower/$version/$lower.nuspec"
          Write-Host "Checking $checkUrl"
          $exists = $false
          try {
            # Use HEAD to just check existence
            $resp = Invoke-WebRequest -Uri $checkUrl -Method Head -UseBasicParsing -TimeoutSec 15 -ErrorAction Stop
            $exists = $true
          } catch {
            $exists = $false
          }

          if ($exists) {
            Write-Host "Version $version of $packageId exists on nuget.org — attempting delete (requires delete permission in API key)."
            # API key from NuGet/login step:
            $apiKey = "${{ steps.login.outputs.NUGET_API_KEY }}"
            if (-not $apiKey) {
              Write-Error "No NUGET API key available from login step."
              exit 1
            }

            # Attempt delete. This will fail if the API key doesn't have delete permission or nuget.org disallows deletion.
            dotnet nuget delete $packageId $version `
              --api-key $apiKey `
              --source https://api.nuget.org/v3/index.json `
              --non-interactive

            Write-Host "Delete command finished. Check the previous output for success/failure."
          } else {
            Write-Host "Version $version of $packageId NOT found on nuget.org — continuing to push."
          }

      - name: push to NuGet
        shell: pwsh
        run: |
          $pkg = Get-ChildItem -Path ./artifacts -Filter "NanoJson.${{ env.VERSION }}*.nupkg" | Select-Object -First 1
          if (-not $pkg) { 
            Write-Error "Package not found: ./artifacts/NanoJson.${{ env.VERSION }}.nupkg"
            exit 1
          }
          dotnet nuget push $pkg.FullName `
            --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" `
            --source https://api.nuget.org/v3/index.json
